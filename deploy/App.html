<!DOCTYPE html>
<html>
<head>
    <title>cycletimebystate</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>
    <script type="text/javascript" src="https://storage.googleapis.com/versions.lumenize.com/v0.7.2/Lumenize-min.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.3.1/moment.min.js"></script>
    <script type="text/javascript" src="https://raw.github.com/nicolaskruchten/pivottable/master/examples/pivot.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){console.log("launch"),app=this,this.startDate=moment().subtract("month",3).toISOString(),this.createUI();var panel=Ext.create("Ext.container.Container",{itemId:"panel",title:"Hello",width:800,height:600,html:"<p>World!</p>"});this.add(panel);var p=this.down("#panel");app.jqPanel="#"+p.id},run:function(){async.waterfall([app.getCompletedItems,app.getSnapshotsForCompletedItems,app.prepareSnapshots,app.pivotData],function(err,results){console.log("whole mess of results ",results)})},createUI:function(){var createButton=function(){app.goButton&&app.goButton.destroy(),app.goButton=Ext.create("Rally.ui.Button",{margin:5,height:20,text:"Go",handler:function(){console.log("fieldCombo:",app.fieldCombo.getValue()),console.log("valueCombo:",app.valueCombo.getValue()),app.kanbanField=app.fieldCombo.getValue(),app.finalValue=app.valueCombo.getValue(),app.run()}}),app.boxcontainer.add(app.goButton)},createValueCombo=function(valuefield){return app.valueCombo&&app.valueCombo.destroy(),app.valueCombo=Ext.create("Rally.ui.combobox.FieldValueComboBox",{padding:5,stateful:!0,stateId:"Rally.ui.combobox.FieldValueComboBox",model:"UserStory",field:valuefield,listeners:{ready:function(t){console.log("value ready",t.getValue()),""!==t.getValue()&&createButton()},select:function(a,selected,c){console.log("selected",selected[0].get("value")),createButton()}}}),app.valueCombo};app.fieldCombo=Ext.create("Rally.ui.combobox.FieldComboBox",{padding:5,stateful:!0,stateId:"Rally.ui.combobox.FieldComboBox",model:"UserStory",listeners:{ready:function(t,e){createValueCombo(t.getValue()),app.boxcontainer.add(app.valueCombo)},select:function(a,selected,c){console.log("selected",selected),createValueCombo(selected[0].get("value")),app.goButton&&app.goButton.destroy(),app.boxcontainer.add(app.valueCombo)}}}),app.boxcontainer=Ext.create("Ext.container.Container",{itemId:"container",layout:{type:"hbox"},width:400,border:1,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"}}),app.boxcontainer.add(app.fieldCombo),this.add(app.boxcontainer)},getCompletedItems:function(callback){var that=this,fetch=["ObjectID","_TypeHierarchy","_PreviousValues","PlanEstimate","Project",app.kanbanField],hydrate=["_TypeHierarchy",app.kanbanField],find={_TypeHierarchy:{$in:["HierarchicalRequirement","Defect"]},_ProjectHierarchy:{$in:app.getContext().getProject().ObjectID},Children:{$exists:!1}};find[app.kanbanField]=app.finalValue,find["_PreviousValues."+app.kanbanField]={$ne:"null"},find._ValidFrom={$gte:app.startDate};var storeConfig={find:find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:fetch,hydrate:hydrate,listeners:{scope:this,load:function(store,snapshots,success){console.log("success",success),console.log("completed snapshots:",snapshots.length),console.log("unique completed   :",_.uniq(_.map(snapshots,function(s){return s.get("ObjectID")})).length),callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},prepareSnapshots:function(completedItems,snapshots,callback){_.each(snapshots,function(s){var ci=_.find(completedItems,function(c){return c.get("ObjectID")===s.get("ObjectID")}),month=moment(ci.get("_ValidFrom")).format("MMM YYYY");s.set("Month",month),s.set("Size",ci.get("PlanEstimate"))}),callback(null,completedItems,snapshots)},pivotData:function(completedItems,snapshots,callback){var addCommas=function(nStr){var rgx,x,x1,x2;for(nStr+="",x=nStr.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"",rgx=/(\d+)(\d{3})/;rgx.test(x1);)x1=x1.replace(rgx,"$1,$2");return x1+x2},numberFormat=function(sigfig,scaler){return null==sigfig&&(sigfig=3),null==scaler&&(scaler=1),function(x){return 0===x||isNaN(x)||!isFinite(x)?"":addCommas((scaler*x).toFixed(sigfig))}},cycleTime=function(){return function(x,y,z){return{recs:[],push:function(record){return this.recs.push(record),this.recs.length},value:function(value){var ct=calcCyleTime(this.recs);return _.mean(_.pluck(ct,"ticks"))},format:numberFormat(0),label:"cycleTime"}}},calcCyleTime=function(snapshots){var that=this,granularity="day",tz="America/New_York",config={granularity:granularity,tz:tz,validFromField:"_ValidFrom",validToField:"_ValidTo",uniqueIDField:"ObjectID"},start=moment().dayOfYear(0).toISOString(),end=moment().toISOString();tisc=new window.parent._lumenize.TimeInStateCalculator(config),tisc.addSnapshots(snapshots,start,end);var results=tisc.getResults();return results},data=_.map(snapshots,function(s){return s.data});console.log("data",data),console.log("app.kanbanField",app.kanbanField),$(app.jqPanel).pivotUI(data,{aggregators:{cycleTime:cycleTime},rows:[app.kanbanField],cols:["Project"],hiddenAttributes:["PlanEstimate","ObjectID","_TypeHierarchy","_UnformattedID","_ValidFrom","_ValidTo"]}),callback(null,completedItems,snapshots)},readSnapshots:function(config,callback){console.log("reading page of snapshots...");var storeConfig={find:config.find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:config.fetch,hydrate:config.hydrate,listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},getSnapshotsForCompletedItems:function(completedItems,callback){var that=this,completedOids=_.uniq(_.pluck(completedItems,function(c){return c.get("ObjectID")}));console.log("oids",completedOids.length);var oidsArrays=[],i,j,chunk=200;for(i=0,j=completedOids.length;j>i;i+=chunk)oidsArrays.push(completedOids.slice(i,i+chunk));console.log("oidsArrays",oidsArrays);var configs=_.map(oidsArrays,function(oArray){return{fetch:["_UnformattedID","ObjectID","_TypeHierarchy","PlanEstimate","ScheduleState",app.kanbanField],hydrate:["_TypeHierarchy","ScheduleState",app.kanbanField],find:{_TypeHierarchy:{$in:["HierarchicalRequirement","Defect"]},_ProjectHierarchy:{$in:app.getContext().getProject().ObjectID},ObjectID:{$in:oArray}}}});async.mapSeries(configs,app.readSnapshots,function(err,results){var snapshots=[];_.each(results,function(r){snapshots=snapshots.concat(r)}),console.log("total snapshots",snapshots.length),callback(null,completedItems,snapshots)})},summarizeResults:function(stateResults,callback){_.each(stateResults,function(result){var resultTicks=_.pluck(result.results,function(r){return r.ticks});result.min=_.min(resultTicks),result.max=_.max(resultTicks),result.avg=_.reduce(resultTicks,function(memo,num){return memo+num},0)/resultTicks.length,result.median=_.median(_.sortBy(resultTicks),function(r){return r}),result.mean=_.mean(resultTicks,function(r){return r}),result.ticks=_.sortBy(resultTicks)}),callback(null,stateResults)},processSnapshots:function(completedItems,snapshots,callback){var groupedByState=_.groupBy(snapshots,function(s){return s.get(app.kanbanField)});console.log("grouped",groupedByState);var stateSnapshots=_.map(_.keys(groupedByState),function(state){return{state:state,snapshots:groupedByState[state]}});async.map(stateSnapshots,app.calcCyleTimeForState,function(err,results){_.each(results,function(result,i){stateSnapshots[i].results=result}),callback(null,stateSnapshots)})},calcCyleTimeForState:function(stateSnapshots,callback){var that=this,snapshots=_.pluck(stateSnapshots.snapshots,function(s){return s.data}),granularity="day",tz="America/New_York",config={granularity:granularity,tz:tz,validFromField:"_ValidFrom",validToField:"_ValidTo",uniqueIDField:"ObjectID"},start=moment().dayOfYear(0).toISOString(),end=moment().toISOString();tisc=new window.parent._lumenize.TimeInStateCalculator(config),tisc.addSnapshots(snapshots,start,end);var results=tisc.getResults();callback(null,results)}});
                _.mixin({sum:function(obj,iterator,context){if(!iterator&&_.isEmpty(obj))return 0;var result=0;if(!iterator&&_.isArray(obj)){for(var i=obj.length-1;i>-1;i-=1)result+=obj[i];return result}return _.each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;result+=computed}),result},mean:function(obj,iterator,context){return!iterator&&_.isEmpty(obj)?1/0:!iterator&&_.isArray(obj)?_.sum(obj)/obj.length:_.isArray(obj)&&!_.isEmpty(obj)?_.sum(obj,iterator,context)/obj.length:void 0},median:function(obj,iterator,context){if(_.isEmpty(obj))return 1/0;var tmpObj=[];return!iterator&&_.isArray(obj)?(tmpObj=_.clone(obj),tmpObj.sort(function(f,s){return f-s})):_.isArray(obj)&&_.each(obj,function(value,index,list){tmpObj.push(iterator?iterator.call(context,value,index,list):value),tmpObj.sort()}),tmpObj.length%2?tmpObj[Math.floor(tmpObj.length/2)]:_.isNumber(tmpObj[tmpObj.length/2-1])&&_.isNumber(tmpObj[tmpObj.length/2])?(tmpObj[tmpObj.length/2-1]+tmpObj[tmpObj.length/2])/2:tmpObj[tmpObj.length/2-1]},nrange:function(start,stop,step){if(1>=arguments.length){if(0===start)return[];stop=start||0,start=0}step=arguments[2]||1*(stop>start)||-1;var len=Math.max(Math.ceil((stop-start)/step),0),idx=0,range=Array(len);do range[idx]=start,start+=step;while(len>(idx+=1));return range}});

            Rally.launchApp('CustomApp', {
                name:"cycletimebystate",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
    <style type="text/css">
        
table.pvtTable {
    font-family:arial;
    font-size: 8pt;
    text-align: left;
    border-collapse: collapse;
}
table.pvtTable tr th, table.pvtTable tr th {
    background-color: #e6EEEE;
    border: 1px solid #CDCDCD;
    font-size: 8pt;
    padding: 5px;
}

table.pvtTable .pvtColLabel {text-align: center;}
table.pvtTable .pvtTotalLabel {text-align: right;}

table.pvtTable tr td {
    color: #3D3D3D;
    padding: 5px;
    background-color: #FFF;
    border: 1px solid #CDCDCD;
    vertical-align: top;
    text-align: right;
}

.pvtTotal, .pvtGrandTotal { font-weight: bold; }

.pvtAxisContainer {
    border: 1px solid gray;
    background: #EEE;
    padding: 5px;
    min-width: 20px;
    min-height: 20px;
}
.pvtAxisContainer li {
    margin: 5px;
    padding: 5px;
    list-style-type: none;
    cursor:move;
}

.pvtHorizList li { display: inline; }

    </style>
</head>
<body></body>
</html>
