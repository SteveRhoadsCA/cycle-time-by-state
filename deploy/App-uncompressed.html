<!DOCTYPE html>
<html>
<head>
    <title>cycletimebystate</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.3.1/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app = null;

Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    
    // kanbanField : "c_KanbanState",
    // kanbanField : "c_KanbanBoardOperation",
    // finalValue : "Done",
    
    launch: function() {
        //Write app code here
        console.log("launch");
        app = this;
        // this.startDate = moment().startOf('month').toISOString();
        // this.startDate = moment().subtract('month',6).toISOString();
        this.startDate = moment().subtract('month',app.getSetting("months")).toISOString();

        if ((app.getSetting("type") === "") &&
            (app.getSetting("stateField") === "") &&
            (app.getSetting("finalValue") === "")) {
            this.createUI();
        } else {
            app.type = app.getSetting("type");
            app.kanbanField = app.getSetting("stateField");
            app.finalValue  = app.getSetting("finalValue");
        }

        var panel = Ext.create('Ext.container.Container', {
            itemId : 'panel',
            title: 'Hello',
            width: 800,
            height: 600,
            html: '<p></p>'
        });

        this.add(panel);
        var p = this.down("#panel");
        app.jqPanel = "#"+p.id;

        if (!((app.getSetting("stateField") === "") &&
            (app.getSetting("finalValue") === ""))) {
            app.run();
        }

    },

    config: {

    defaultSettings : {

        type : "",
        stateField : "",
        finalValue : "",
        timeInHours : false,
        months : 6

        }
    },

    getSettingsFields: function() {
        var values = [
            {
                name: 'type',
                xtype: 'rallytextfield',
                label : "Comma delimited list of types eg. Story,Defect or PortfolioItem/Feature"
            },

            {
                name: 'stateField',
                xtype: 'rallytextfield',
                label : "Field name cycle time calculation is based on eg. State"
            },
            {
                name: 'finalValue',
                xtype: 'rallytextfield',
                label: 'Filter items that have moved into this state eg. Closed or Accepted'
            },
            {
                name: 'timeInHours',
                xtype: 'rallycheckboxfield',
                label: 'Show cycle time values in hours (instead of days)'
            },
            {
                name: 'months',
                xtype: 'rallytextfield',
                label: 'Number of months to consider'
            }

        ];

        return values;
    },


    run : function () {

        app.mask = new Ext.LoadMask(Ext.getBody(), {msg:"Please wait..."});
        app.mask.show();
        
        async.waterfall([   
            app.getCompletedItems,
            app.getSnapshotsForCompletedItems,
            app.getProjectNamesForCompletedItems,
            app.prepareSnapshots,
            app.pivotData
            ], 
            function( err, results ) {
                app.mask.hide();
            }
        );
    },
    
    createUI : function() {
        
        var createButton = function() {
            if (app.goButton)
                app.goButton.destroy();
            app.goButton = Ext.create("Rally.ui.Button", {
                margin : 5,
                height : 20,
                text : "Go",
                handler: function() {
                    console.log("fieldCombo:",app.fieldCombo.getValue());
                    console.log("valueCombo:",app.valueCombo.getValue());
                    app.kanbanField = app.fieldCombo.getValue()
                    app.finalValue  = app.valueCombo.getValue()
                    app.run();
                }
            });
            app.boxcontainer.add(app.goButton);
            
        };
        
        var createValueCombo = function(valuefield) {
            if (app.valueCombo)
                app.valueCombo.destroy();
            
            app.valueCombo = Ext.create("Rally.ui.combobox.FieldValueComboBox", {
                padding : 5,
                
                stateful : true, stateId : "Rally.ui.combobox.FieldValueComboBox",
                model: 'UserStory',
                field: valuefield,
                listeners : {
                    ready : function(t) {
                        console.log("value ready",t.getValue());
                        if (t.getValue()!=="")
                            createButton();
                    },
                    select : function(a,selected,c) {
                        console.log("selected",selected[0].get("value"));
                        createButton();
                    }
                }
            });
            return app.valueCombo;
        };
        
        app.fieldCombo = Ext.create('Rally.ui.combobox.FieldComboBox', {
            padding : 5,
            stateful : true, stateId : "Rally.ui.combobox.FieldComboBox",
            model: 'UserStory',
            listeners : {
                ready : function(t,e) {
                    createValueCombo(t.getValue());
                    app.boxcontainer.add(app.valueCombo);
                },
                select : function(a,selected,c) {
                    console.log("selected",selected);
                    createValueCombo(selected[0].get("value"));
                    if (app.goButton) app.goButton.destroy();
                    app.boxcontainer.add(app.valueCombo);
                }
            }
        });
        
        app.boxcontainer = Ext.create('Ext.container.Container', {
            itemId : "container",
            layout: { type: 'hbox'},
            width: 400,
            border: 1,
            style: {borderColor:'#000000', borderStyle:'solid', borderWidth:'1px'},
            // padding : 5
        });
        app.boxcontainer.add(app.fieldCombo);
        this.add(app.boxcontainer);
        
    },

    getTypes : function() {

        var types = _.map( app.type.split(","), function(t) {
            return t.toUpperCase() !== "STORY" ? t : "HierarchicalRequirement";
        });
        console.log("types:",types);
        return types;
    },
    
    // reads the snapshots for items that have been completed since the specified start date.
    getCompletedItems : function( callback ) {
        
        var that = this;

        var fetch = ['FormattedID','ObjectID','_TypeHierarchy','_PreviousValues','PlanEstimate','Project',app.kanbanField];
        var hydrate = ['_TypeHierarchy',app.kanbanField];
        
        var find = {
                // '_TypeHierarchy' : { "$in" : ["HierarchicalRequirement","Defect"]} ,
                '_TypeHierarchy' : { "$in" : app.getTypes() } ,
                '_ProjectHierarchy' : { "$in": [app.getContext().getProject().ObjectID] },
                // 'Children' : { "$exists" : false}
        };
        // for stories only include child level items
        if ( _.findIndex(app.getTypes(),function(t){
            return t.toUpperCase()==="HIERARCHICALREQUIREMENT";
        }) !== -1) {
            find['Children'] = { "$exists" : false}
        }

        find[app.kanbanField] =  app.finalValue;
        find["_PreviousValues."+app.kanbanField] =  {"$ne" : null };
        find["_ValidFrom"] = { "$gte" : app.startDate };

        var storeConfig = {
            find : find,
            autoLoad : true,
            pageSize:1000,
            limit: 'Infinity',
            fetch: fetch,
            hydrate: hydrate,
            listeners : {
                scope : this,
                load: function(store, snapshots, success) {
                    console.log("success",success);
                    console.log("completed snapshots:", snapshots.length);
                    console.log("unique completed   :", _.uniq(_.map(snapshots,function(s){return s.get("ObjectID");})).length);
                    callback(null,snapshots);
                }
            }
        };

        var snapshotStore = Ext.create('Rally.data.lookback.SnapshotStore', storeConfig);
        
    },

    // will process the snapshots adding additional elements
    prepareSnapshots : function(completedItems, snapshots,callback) {

        _.each(snapshots, function(s) {
            // set the month
            var ci = _.find(completedItems,function(c) { return c.get("ObjectID") === s.get("ObjectID");});
            var month = moment(ci.get("_ValidFrom")).format ("MMM YYYY");
            s.set("CompletedDate",ci.get("_ValidFrom"));
            s.set("Month",month);
            s.set("Size",ci.get("PlanEstimate"));
        });

        callback( null, completedItems, snapshots );

    },

    pivotData : function( completedItems, snapshots, callback ) {

        var addCommas = function(nStr) {
            var rgx, x, x1, x2;
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
              x1 = x1.replace(rgx, '$1' + ',' + '$2');
            }
            return x1 + x2;
          };

        var numberFormat = function(sigfig, scaler) {
            if (sigfig == null) {
              sigfig = 3;
            }
            if (scaler == null) {
              scaler = 1;
            }
            return function(x) {
              if (x === 0 || isNaN(x) || !isFinite(x)) {
                return "";
              } else {
                return addCommas((scaler * x).toFixed(sigfig));
              }
            };
        };

        var cycleTime = function() {

          return function(x,y,z) {
            var xx = x;
            var yy = y;
            var zz = z;
            return {
              recs : [],

              push: function(record) {
                this.recs.push(record);
                // return this.count++;
                return this.recs.length;
              },
              value: function(value) {
                console.log("Records for:",yy,zz);
                // console.log("calculating cycle time for #records:",this.recs.length);
                // console.log("#records:",this.recs);
                var ct = (calcCyleTime(this.recs));
                // console.log("ct",ct);
                console.log("#ids",_.pluck(ct,"FormattedID"));
                console.log("#cycletimes",_.pluck(ct,"ticks"));
                var mean = _.mean( _.pluck(ct,"ticks"));
                var median = _.median( _.pluck(ct,"ticks"));
                var max = _.max( _.pluck(ct,"ticks"));
                var min = _.min( _.pluck(ct,"ticks"));
                var cnt = _.pluck(ct,"ticks").length;
                var stddev = _.stdDeviation(_.pluck(ct,"ticks"));
                var cov = (mean!==0) ?stddev / mean : 0;
                mean = parseFloat(Math.round(mean * 100) / 100).toFixed(2);
                median = parseFloat(Math.round(median * 100) / 100).toFixed(2);
                stddev = parseFloat(Math.round(stddev * 100) / 100).toFixed(2);
                cov    = parseFloat(Math.round(cov * 100) / 100).toFixed(2);

                console.log("cnt/mean/median/max/min/stddev/cov",cnt,",",mean,",",median,",",max,",",min,",",stddev,",",cov);
                return mean
              },
              format: numberFormat(0),
              label: "cycleTime"
            };
          };
        };

        var calcCyleTime = function( snapshots ) {
                // console.time("cycle-time");
                var that = this;
                // var granularity = 'day';
                var granularity = app.getSetting("timeInHours") === false ? 'day' : 'hour';
                var tz = 'America/New_York';
                
                var config = { //  # default work days and holidays
                    granularity: granularity,
                    tz: tz,
                    validFromField: '_ValidFrom',
                    validToField: '_ValidTo',
                    // uniqueIDField: 'ObjectID',
                    uniqueIDField: 'FormattedID',
                    workDayStartOn: {hour: 13, minute: 0}, // # 09:00 in Chicago is 15:00 in GMT
                    workDayEndBefore: {hour: 22, minute: 0} // # 11:00 in Chicago is 17:00 in GMT  # 
                };
                
                // var start = moment().dayOfYear(0).toISOString();
                var start = moment().subtract(1, 'years').toISOString();
                var end =   moment().toISOString();
                var tisc = null;
                if (_.isUndefined(window.parent._lumenize)) {
                    tisc = new window._lumenize.TimeInStateCalculator(config);
                } else {
                    tisc = new window.parent._lumenize.TimeInStateCalculator(config);
                }
                tisc.addSnapshots(snapshots, start, end);
                var results = tisc.getResults();
                console.timeEnd("cycle-time");
                // callback(null,results);
                return results;
        };

        var teamNameDeriver = function(record) {

            var p = _.find(app.projects, function(f) { return record.Project === f.get("ObjectID");});

            return p ? p.get("Name") : record.Project;

        };

        var completedDateDeriver = function(record) {
            return moment(record.CompletedDate).format ("MMM YYYY");
        }

        var data = _.map(snapshots,function(s) { 
            return s.data;
        });

        $(app.jqPanel).pivotUI(
            data,                    
            {
                derivedAttributes : { "Team" : teamNameDeriver, "MonthCompleted" : completedDateDeriver },
                aggregators : { cycleTime : cycleTime },
                rows: [app.kanbanField],
                cols: ["Team"],
                hiddenAttributes : ["PlanEstimate", "ObjectID","_TypeHierarchy","_UnformattedID","_ValidFrom","_ValidTo","Project","CompletedDate"]
            }
        );
        
        callback( null, completedItems, snapshots );
    },

    readSnapshots : function( config, callback) {
        console.log("reading page of snapshots...");
         var storeConfig = {
            find : config.find,
            autoLoad : true,
            pageSize:1000,
            limit: 'Infinity',
            fetch: config.fetch,
            hydrate: config.hydrate,
            listeners : {
                scope : this,
                load: function(store, snapshots, success) {
                    callback(null,snapshots);
                }
            }
        };
        var snapshotStore = Ext.create('Rally.data.lookback.SnapshotStore', storeConfig);
    },

    getProjectNamesForCompletedItems : function(completedItems,snapshots,callback) {

        var projectOids = _.uniq(_.pluck( snapshots, function(c) { return c.get("Project");}) );
        console.log("Distinct Project IDs:",projectOids);

        var configs = _.map(projectOids, function(p) {
            return {
                    model : "Project",
                    fetch : ["Name","ObjectID","FormattedID"],
                    filters : [{property:"ObjectID",value:p}]
                };
        });

        async.map(configs,app.wsapiQuery,function(err,results) {

            app.projects = _.flatten(results);

            // remove snapshots where the project was not found (out of scope, closed etc.)
            var filteredSnapshots = _.filter(snapshots,function(s) {
                var p = _.find( app.projects, function(p) { 
                    return s.get("Project")===p.get("ObjectID");
                });
                return !_.isUndefined(p) && !_.isNull(p);
            });

            console.log("projects:",app.projects);
            // pass on to next function in the chain.
            callback(null,completedItems,filteredSnapshots);

        });

    },
    
    getSnapshotsForCompletedItems : function(completedItems,callback) {

        var that = this;

        var completedOids = _.uniq( _.pluck( completedItems, function(c) { return c.get("ObjectID"); } ));        
        console.log("oids",completedOids.length);

        var oidsArrays = [];
        var i,j,chunk = 50;
        for (i=0, j=completedOids.length; i<j; i+=chunk) {          
            oidsArrays.push(completedOids.slice(i,i+chunk));
        }
        console.log("oidsArrays",oidsArrays);

        var configs = _.map( oidsArrays, function(oArray) {
            return {
                fetch : ['FormattedID','_UnformattedID','ObjectID','_TypeHierarchy','PlanEstimate', 'ScheduleState',app.kanbanField],
                hydrate : ['_TypeHierarchy','ScheduleState',app.kanbanField],
                find : {
                    // '_TypeHierarchy' : { "$in" : ["HierarchicalRequirement","Defect"]} ,
                    '_TypeHierarchy' : { "$in" : app.getTypes() } ,
                    '_ProjectHierarchy' : { "$in": [app.getContext().getProject().ObjectID] }, 
                    'ObjectID' : { "$in" : oArray }
                }
            }
        })

        async.mapSeries( configs, app.readSnapshots, function(err,results) {

            var snapshots = [];
            _.each(results,function(r) {
                snapshots = snapshots.concat(r);
            });
            console.log("total snapshots",snapshots.length);
            callback(null,completedItems,snapshots)

        });


    }, 
    
    summarizeResults : function( stateResults, callback ) {
      
        _.each(stateResults, function(result) {
            
            var resultTicks = _.pluck(result.results, function(r) { return r.ticks; });
            result.min = _.min( resultTicks ) ;
            result.max = _.max( resultTicks );
            result.avg = _.reduce(resultTicks, function(memo, num) {
        		    return memo + num;
                }, 0) / resultTicks.length;
                
            result.median = _.median( _.sortBy(resultTicks) , function(r) { return r;});
            result.mean   = _.mean( resultTicks , function(r) { return r;});
            result.ticks = _.sortBy(resultTicks);
        });
        callback(null,stateResults);
        
    },
    
    wsapiQuery : function( config , callback ) {
        Ext.create('Rally.data.WsapiDataStore', {
            autoLoad : true,
            limit : "Infinity",
            model : config.model,
            fetch : config.fetch,
            filters : config.filters,
            // context: config.context,
            listeners : {
                scope : this,
                load : function(store, data) {
                    callback(null,data);
                }
            }
        });
    }

});

                (function() {

  var math = this.math = {};

  // Arithmetic mean
  // math.mean([1,2,3])
  //   => 2
  math.mean = math.ave = math.average = function(obj, key) {
    return math.sum(obj, key) / _.size(obj);
  };

  // math.median([1,2,3,4])
  //   => 2.5
  //   TODO {}, [{}]
  math.median = function(arr) {
    arr = arr.slice(0); // create copy
    var middle = (arr.length + 1) / 2,
      sorted = math.sort(arr);
    return (sorted.length % 2) ? sorted[middle - 1] : (sorted[middle - 1.5] + sorted[middle - 0.5]) / 2;
  };

  // Power, exponent
  // math.pow(2,3)
  //   => 8
  math.pow = math.power = function(x, n) {
     if (_.isNumber(x))
        return Math.pow(x, n);
     if (_.isArray(x))
        return _.map(x, function(i) { return _.pow(i, n); });
  };

  // Round
  // math.round(12345.6789, 2)
  //   => 12345.68
  math.round = function(number, decimals) {
    return Math.round(number * Math.pow(10, decimals)) / Math.pow(10, decimals);
  };

  // Scale to max value
  // math.scale(1,[2,5,10])
  //   => [ 0.2, 0.5, 1]
  math.scale = function(arr, max) {
    max = max || 1;
    var max0 = _.max(arr);
    return _.map(arr, function(i) { return i * (max / max0); });
  };

  // Slope between two points
  // math.slope([0,0],[1,2])
  //   => 2
  math.slope = function(x, y) {
    return (y[1] - x[1]) / (y[0] - x[0]);
  };

  // Numeric sort
  // math.sort([3,1,2])
  //   => [1,2,3]
  math.sort = function(arr) {
    return _.sortBy(arr, _.identity);
  };

   // math.stdDeviation([1,2,3])
  //   => 0.816496580927726
  math.stdDeviation = math.sigma = function(arr) {
    return Math.sqrt(_.variance(arr));
  };

  // Sum of array
  // math.sum([1,2,3])
  //   => 6
  // math.sum([{b: 4},{b: 5},{b: 6}], 'b')
  //   => 15
  math.sum = function(obj, key) {
    var arr;
    if (_.isArray(obj) && typeof obj[0] === 'number') {
      arr = obj;
    } else {
      key = key || 'value';
      arr = _.pluck(obj, key);
    }
    var val = 0, i;
    for (i = 0; i < arr.length; i++)
      val += (arr[i]-0);
    return val;
  };

  // math.transpose(([1,2,3], [4,5,6], [7,8,9]])
  //   => [[1,4,7], [2,5,8], [3,6,9]]
  math.transpose = function(arr) {
    var trans = [];
    _.each(arr, function(row, y){
      _.each(row, function(col, x){
        if (!trans[x]) trans[x] = [];
        trans[x][y] = col;
      });
    });
    return trans;
  };

  // math.variance([1,2,3])
  //   => 2/3
  math.variance = function(arr) {
    var mean = _.mean(arr),
      variance = function(x) { return _.pow( x - mean, 2); };
    return _(arr).map(variance).mean().value();
  };

  // Standard score, assuming normal distribution
  // math.zscore([1,2,3])
  //   => [-1.224744871391589, 0, 1.224744871391589]
  math.zscore = function(obj, key) {
    var arr;
    if (_.isArray(obj) && typeof obj[0] === 'number') {
      arr = obj;
    } else {
      key = key || 'value';
      arr = _.pluck(obj, key);
    }

    var mean = _.mean(arr),
        sigma = _.stdDeviation(arr),
        zscore = function(d) { return (d - mean) / sigma; };
    return _.map(arr, zscore);
  };

  // math.movingAvg([1,2,3,4,5], 3);
  //   => [2,3,4]
  math.movingAvg = math.movingAverage = function(arr, size) {
    var win, i, newarr = [];
    for(i = size-1; i <= arr.length; i++) {
      win = arr.slice(i - size, i);
      if (win.length === size) {
        newarr.push(_.mean(win));
      }
    }
    return newarr;
  };

  // add methods to Underscore.js namespace
  _.mixin(math);

})();

                // Generated by CoffeeScript 1.6.3
(function() {
  var $, PivotData, addSeparators, aggregatorTemplates, aggregators, convertToArray, dayNames, deriveAttributes, derivers, forEachRecord, getPivotData, mthNames, naturalSort, numberFormat, pivotTableRenderer, renderers, spanSize, zeroPad,
    __slice = [].slice,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
    _this = this,
    __hasProp = {}.hasOwnProperty,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  $ = jQuery;

  /*
  Utilities
  */


  addSeparators = function(nStr, thousandsSep, decimalSep) {
    var rgx, x, x1, x2;
    nStr += '';
    x = nStr.split('.');
    x1 = x[0];
    x2 = x.length > 1 ? decimalSep + x[1] : '';
    rgx = /(\d+)(\d{3})/;
    while (rgx.test(x1)) {
      x1 = x1.replace(rgx, '$1' + thousandsSep + '$2');
    }
    return x1 + x2;
  };

  numberFormat = function(sigfig, scaler, thousandsSep, decimalSep) {
    if (sigfig == null) {
      sigfig = 3;
    }
    if (scaler == null) {
      scaler = 1;
    }
    if (thousandsSep == null) {
      thousandsSep = ",";
    }
    if (decimalSep == null) {
      decimalSep = ".";
    }
    return function(x) {
      if (x === 0 || isNaN(x) || !isFinite(x)) {
        return "";
      } else {
        return addSeparators((scaler * x).toFixed(sigfig), thousandsSep, decimalSep);
      }
    };
  };

  aggregatorTemplates = {
    sum: function(sigfig, scaler) {
      if (sigfig == null) {
        sigfig = 3;
      }
      if (scaler == null) {
        scaler = 1;
      }
      return function(_arg) {
        var attr;
        attr = _arg[0];
        return function() {
          return {
            sum: 0,
            push: function(record) {
              if (!isNaN(parseFloat(record[attr]))) {
                return this.sum += parseFloat(record[attr]);
              }
            },
            value: function() {
              return this.sum;
            },
            format: numberFormat(sigfig, scaler),
            label: "Sum of " + attr
          };
        };
      };
    },
    average: function(sigfig, scaler) {
      if (sigfig == null) {
        sigfig = 3;
      }
      if (scaler == null) {
        scaler = 1;
      }
      return function(_arg) {
        var attr;
        attr = _arg[0];
        return function() {
          return {
            sum: 0,
            len: 0,
            push: function(record) {
              if (!isNaN(parseFloat(record[attr]))) {
                this.sum += parseFloat(record[attr]);
                return this.len++;
              }
            },
            value: function() {
              return this.sum / this.len;
            },
            format: numberFormat(sigfig, scaler),
            label: "Average of " + attr
          };
        };
      };
    },
    sumOverSum: function(sigfig, scaler) {
      if (sigfig == null) {
        sigfig = 3;
      }
      if (scaler == null) {
        scaler = 1;
      }
      return function(_arg) {
        var denom, num;
        num = _arg[0], denom = _arg[1];
        return function() {
          return {
            sumNum: 0,
            sumDenom: 0,
            push: function(record) {
              if (!isNaN(parseFloat(record[num]))) {
                this.sumNum += parseFloat(record[num]);
              }
              if (!isNaN(parseFloat(record[denom]))) {
                return this.sumDenom += parseFloat(record[denom]);
              }
            },
            value: function() {
              return this.sumNum / this.sumDenom;
            },
            format: numberFormat(sigfig, scaler),
            label: "" + num + "/" + denom
          };
        };
      };
    },
    sumOverSumBound80: function(sigfig, scaler, upper) {
      if (sigfig == null) {
        sigfig = 3;
      }
      if (scaler == null) {
        scaler = 1;
      }
      if (upper == null) {
        upper = true;
      }
      return function(_arg) {
        var denom, num;
        num = _arg[0], denom = _arg[1];
        return function() {
          return {
            sumNum: 0,
            sumDenom: 0,
            push: function(record) {
              if (!isNaN(parseFloat(record[num]))) {
                this.sumNum += parseFloat(record[num]);
              }
              if (!isNaN(parseFloat(record[denom]))) {
                return this.sumDenom += parseFloat(record[denom]);
              }
            },
            value: function() {
              var sign;
              sign = upper ? 1 : -1;
              return (0.821187207574908 / this.sumDenom + this.sumNum / this.sumDenom + 1.2815515655446004 * sign * Math.sqrt(0.410593603787454 / (this.sumDenom * this.sumDenom) + (this.sumNum * (1 - this.sumNum / this.sumDenom)) / (this.sumDenom * this.sumDenom))) / (1 + 1.642374415149816 / this.sumDenom);
            },
            format: numberFormat(sigfig, scaler),
            label: "" + (upper ? "Upper" : "Lower") + " Bound of " + num + "/" + denom
          };
        };
      };
    },
    fractionOf: function(wrapped, type) {
      if (type == null) {
        type = "total";
      }
      return function() {
        var x;
        x = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
        return function(data, rowKey, colKey) {
          return {
            selector: {
              total: [[], []],
              row: [rowKey, []],
              col: [[], colKey]
            }[type],
            inner: wrapped.apply(null, x)(data, rowKey, colKey),
            push: function(record) {
              return this.inner.push(record);
            },
            format: function(v) {
              return numberFormat(2)(100 * v) + "%";
            },
            label: wrapped.apply(null, x)(data, rowKey, colKey).label + " % of " + type,
            value: function() {
              return this.inner.value() / data.getAggregator.apply(data, this.selector).inner.value();
            }
          };
        };
      };
    },
    l10nWrapper: function(wrapped, formatter, labelFn) {
      return function() {
        var x;
        x = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
        return function(data, rowKey, colKey) {
          return {
            inner: wrapped.apply(null, x)(data, rowKey, colKey),
            push: function(record) {
              return this.inner.push(record);
            },
            format: formatter,
            label: labelFn(data),
            value: function() {
              return this.inner.value();
            }
          };
        };
      };
    }
  };

  aggregators = {
    count: function() {
      return function() {
        return {
          count: 0,
          push: function() {
            return this.count++;
          },
          value: function() {
            return this.count;
          },
          format: numberFormat(0),
          label: "Count"
        };
      };
    },
    countUnique: function(_arg) {
      var attr;
      attr = _arg[0];
      return function() {
        return {
          uniq: [],
          push: function(record) {
            var _ref;
            if (_ref = record[attr], __indexOf.call(this.uniq, _ref) < 0) {
              return this.uniq.push(record[attr]);
            }
          },
          value: function() {
            return this.uniq.length;
          },
          format: numberFormat(0),
          label: "Count Unique " + attr
        };
      };
    },
    listUnique: function(_arg) {
      var attr;
      attr = _arg[0];
      return function() {
        return {
          uniq: [],
          push: function(record) {
            var _ref;
            if (_ref = record[attr], __indexOf.call(this.uniq, _ref) < 0) {
              return this.uniq.push(record[attr]);
            }
          },
          value: function() {
            return this.uniq.join(", ");
          },
          format: function(x) {
            return x;
          },
          label: "List Unique " + attr
        };
      };
    },
    intSum: aggregatorTemplates.sum(0),
    sum: aggregatorTemplates.sum(3),
    average: aggregatorTemplates.average(3),
    sumOverSum: aggregatorTemplates.sumOverSum(3),
    ub80: aggregatorTemplates.sumOverSumBound80(3, 1, true),
    lb80: aggregatorTemplates.sumOverSumBound80(3, 1, false)
  };

  aggregators.sumAsFractionOfTotal = aggregatorTemplates.fractionOf(aggregators.sum);

  aggregators.sumAsFractionOfRow = aggregatorTemplates.fractionOf(aggregators.sum, "row");

  aggregators.sumAsFractionOfCol = aggregatorTemplates.fractionOf(aggregators.sum, "col");

  aggregators.countAsFractionOfTotal = aggregatorTemplates.fractionOf(aggregators.count);

  aggregators.countAsFractionOfRow = aggregatorTemplates.fractionOf(aggregators.count, "row");

  aggregators.countAsFractionOfCol = aggregatorTemplates.fractionOf(aggregators.count, "col");

  renderers = {
    "Table": function(pvtData, opts) {
      return pivotTableRenderer(pvtData, opts);
    },
    "Table Barchart": function(pvtData, opts) {
      return pivotTableRenderer(pvtData, opts).barchart();
    },
    "Heatmap": function(pvtData, opts) {
      return pivotTableRenderer(pvtData, opts).heatmap();
    },
    "Row Heatmap": function(pvtData, opts) {
      return pivotTableRenderer(pvtData, opts).heatmap("rowheatmap");
    },
    "Col Heatmap": function(pvtData, opts) {
      return pivotTableRenderer(pvtData, opts).heatmap("colheatmap");
    }
  };

  mthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

  dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

  zeroPad = function(number) {
    return ("0" + number).substr(-2, 2);
  };

  derivers = {
    bin: function(col, binWidth) {
      return function(record) {
        return record[col] - record[col] % binWidth;
      };
    },
    dateFormat: function(col, formatString) {
      return function(record) {
        var date;
        date = new Date(Date.parse(record[col]));
        if (isNaN(date)) {
          return "";
        }
        return formatString.replace(/%(.)/g, function(m, p) {
          switch (p) {
            case "y":
              return date.getFullYear();
            case "m":
              return zeroPad(date.getMonth() + 1);
            case "n":
              return mthNames[date.getMonth()];
            case "d":
              return zeroPad(date.getDate());
            case "w":
              return dayNames[date.getDay()];
            case "x":
              return date.getDay();
            case "H":
              return zeroPad(date.getHours());
            case "M":
              return zeroPad(date.getMinutes());
            case "S":
              return zeroPad(date.getSeconds());
            default:
              return "%" + p;
          }
        });
      };
    }
  };

  naturalSort = function(as, bs) {
    var a, a1, b, b1, rd, rx, rz;
    rx = /(\d+)|(\D+)/g;
    rd = /\d/;
    rz = /^0/;
    if (typeof as === "number" || typeof bs === "number") {
      if (isNaN(as)) {
        return 1;
      }
      if (isNaN(bs)) {
        return -1;
      }
      return as - bs;
    }
    a = String(as).toLowerCase();
    b = String(bs).toLowerCase();
    if (a === b) {
      return 0;
    }
    if (!(rd.test(a) && rd.test(b))) {
      return (a > b ? 1 : -1);
    }
    a = a.match(rx);
    b = b.match(rx);
    while (a.length && b.length) {
      a1 = a.shift();
      b1 = b.shift();
      if (a1 !== b1) {
        if (rd.test(a1) && rd.test(b1)) {
          return a1.replace(rz, ".0") - b1.replace(rz, ".0");
        } else {
          return (a1 > b1 ? 1 : -1);
        }
      }
    }
    return a.length - b.length;
  };

  $.pivotUtilities = {
    aggregatorTemplates: aggregatorTemplates,
    aggregators: aggregators,
    renderers: renderers,
    derivers: derivers,
    naturalSort: naturalSort,
    numberFormat: numberFormat
  };

  /*
  functions for accessing input
  */


  deriveAttributes = function(record, derivedAttributes, f) {
    var k, v, _ref;
    for (k in derivedAttributes) {
      v = derivedAttributes[k];
      record[k] = (_ref = v(record)) != null ? _ref : record[k];
    }
    for (k in record) {
      if (!__hasProp.call(record, k)) continue;
      if (record[k] == null) {
        record[k] = "null";
      }
    }
    return f(record);
  };

  forEachRecord = function(input, derivedAttributes, f) {
    var addRecord, compactRecord, i, j, k, record, tblCols, _i, _len, _ref, _results, _results1;
    addRecord = function(record) {
      return deriveAttributes(record, derivedAttributes, f);
    };
    if ($.isFunction(input)) {
      return input(addRecord);
    } else if ($.isArray(input)) {
      if ($.isArray(input[0])) {
        _results = [];
        for (i in input) {
          if (!__hasProp.call(input, i)) continue;
          compactRecord = input[i];
          if (!(i > 0)) {
            continue;
          }
          record = {};
          _ref = input[0];
          for (j in _ref) {
            if (!__hasProp.call(_ref, j)) continue;
            k = _ref[j];
            record[k] = compactRecord[j];
          }
          _results.push(addRecord(record));
        }
        return _results;
      } else {
        _results1 = [];
        for (_i = 0, _len = input.length; _i < _len; _i++) {
          record = input[_i];
          _results1.push(addRecord(record));
        }
        return _results1;
      }
    } else if (input instanceof jQuery) {
      tblCols = [];
      $("thead > tr > th", input).each(function(i) {
        return tblCols.push($(this).text());
      });
      return $("tbody > tr", input).each(function(i) {
        record = {};
        $("td", this).each(function(j) {
          return record[tblCols[j]] = $(this).text();
        });
        return addRecord(record);
      });
    } else {
      throw new Error("unknown input format");
    }
  };

  convertToArray = function(input) {
    var result;
    result = [];
    forEachRecord(input, {}, function(record) {
      return result.push(record);
    });
    return result;
  };

  PivotData = (function() {
    function PivotData(aggregator, colAttrs, rowAttrs) {
      this.aggregator = aggregator;
      this.colAttrs = colAttrs;
      this.rowAttrs = rowAttrs;
      this.getAggregator = __bind(this.getAggregator, this);
      this.flattenKey = __bind(this.flattenKey, this);
      this.getRowKeys = __bind(this.getRowKeys, this);
      this.getColKeys = __bind(this.getColKeys, this);
      this.sortKeys = __bind(this.sortKeys, this);
      this.arrSort = __bind(this.arrSort, this);
      this.natSort = __bind(this.natSort, this);
      this.tree = {};
      this.rowKeys = [];
      this.colKeys = [];
      this.flatRowKeys = [];
      this.flatColKeys = [];
      this.rowTotals = {};
      this.colTotals = {};
      this.allTotal = this.aggregator(this, [], []);
      this.sorted = false;
    }

    PivotData.prototype.natSort = function(as, bs) {
      return naturalSort(as, bs);
    };

    PivotData.prototype.arrSort = function(a, b) {
      return this.natSort(a.join(), b.join());
    };

    PivotData.prototype.sortKeys = function() {
      if (!this.sorted) {
        this.rowKeys.sort(this.arrSort);
        this.colKeys.sort(this.arrSort);
      }
      return this.sorted = true;
    };

    PivotData.prototype.getColKeys = function() {
      this.sortKeys();
      return this.colKeys;
    };

    PivotData.prototype.getRowKeys = function() {
      this.sortKeys();
      return this.rowKeys;
    };

    PivotData.prototype.flattenKey = function(x) {
      return x.join(String.fromCharCode(0));
    };

    PivotData.prototype.processRecord = function(record) {
      var colKey, flatColKey, flatRowKey, rowKey, x;
      colKey = (function() {
        var _i, _len, _ref, _results;
        _ref = this.colAttrs;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          x = _ref[_i];
          _results.push(record[x]);
        }
        return _results;
      }).call(this);
      rowKey = (function() {
        var _i, _len, _ref, _results;
        _ref = this.rowAttrs;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          x = _ref[_i];
          _results.push(record[x]);
        }
        return _results;
      }).call(this);
      flatRowKey = this.flattenKey(rowKey);
      flatColKey = this.flattenKey(colKey);
      this.allTotal.push(record);
      if (rowKey.length !== 0) {
        if (__indexOf.call(this.flatRowKeys, flatRowKey) < 0) {
          this.rowKeys.push(rowKey);
          this.flatRowKeys.push(flatRowKey);
        }
        if (!this.rowTotals[flatRowKey]) {
          this.rowTotals[flatRowKey] = this.aggregator(this, rowKey, []);
        }
        this.rowTotals[flatRowKey].push(record);
      }
      if (colKey.length !== 0) {
        if (__indexOf.call(this.flatColKeys, flatColKey) < 0) {
          this.colKeys.push(colKey);
          this.flatColKeys.push(flatColKey);
        }
        if (!this.colTotals[flatColKey]) {
          this.colTotals[flatColKey] = this.aggregator(this, [], colKey);
        }
        this.colTotals[flatColKey].push(record);
      }
      if (colKey.length !== 0 && rowKey.length !== 0) {
        if (!(flatRowKey in this.tree)) {
          this.tree[flatRowKey] = {};
        }
        if (!(flatColKey in this.tree[flatRowKey])) {
          this.tree[flatRowKey][flatColKey] = this.aggregator(this, rowKey, colKey);
        }
        return this.tree[flatRowKey][flatColKey].push(record);
      }
    };

    PivotData.prototype.getAggregator = function(rowKey, colKey) {
      var agg, flatColKey, flatRowKey;
      flatRowKey = this.flattenKey(rowKey);
      flatColKey = this.flattenKey(colKey);
      if (rowKey.length === 0 && colKey.length === 0) {
        agg = this.allTotal;
      } else if (rowKey.length === 0) {
        agg = this.colTotals[flatColKey];
      } else if (colKey.length === 0) {
        agg = this.rowTotals[flatRowKey];
      } else {
        agg = this.tree[flatRowKey][flatColKey];
      }
      return agg != null ? agg : {
        value: (function() {
          return null;
        }),
        format: function() {
          return "";
        }
      };
    };

    return PivotData;

  })();

  getPivotData = function(input, cols, rows, aggregator, filter, derivedAttributes) {
    var pivotData;
    pivotData = new PivotData(aggregator, cols, rows);
    forEachRecord(input, derivedAttributes, function(record) {
      if (filter(record)) {
        return pivotData.processRecord(record);
      }
    });
    return pivotData;
  };

  spanSize = function(arr, i, j) {
    var len, noDraw, stop, x, _i, _j;
    if (i !== 0) {
      noDraw = true;
      for (x = _i = 0; 0 <= j ? _i <= j : _i >= j; x = 0 <= j ? ++_i : --_i) {
        if (arr[i - 1][x] !== arr[i][x]) {
          noDraw = false;
        }
      }
      if (noDraw) {
        return -1;
      }
    }
    len = 0;
    while (i + len < arr.length) {
      stop = false;
      for (x = _j = 0; 0 <= j ? _j <= j : _j >= j; x = 0 <= j ? ++_j : --_j) {
        if (arr[i][x] !== arr[i + len][x]) {
          stop = true;
        }
      }
      if (stop) {
        break;
      }
      len++;
    }
    return len;
  };

  pivotTableRenderer = function(pivotData, opts) {
    var aggregator, c, colAttrs, colKey, colKeys, defaults, i, j, r, result, rowAttrs, rowKey, rowKeys, th, totalAggregator, tr, txt, val, x;
    defaults = {
      localeStrings: {
        totals: "Totals"
      }
    };
    opts = $.extend(defaults, opts);
    colAttrs = pivotData.colAttrs;
    rowAttrs = pivotData.rowAttrs;
    rowKeys = pivotData.getRowKeys();
    colKeys = pivotData.getColKeys();
    result = $("<table class='table table-bordered pvtTable'>");
    for (j in colAttrs) {
      if (!__hasProp.call(colAttrs, j)) continue;
      c = colAttrs[j];
      tr = $("<tr>");
      if (parseInt(j) === 0 && rowAttrs.length !== 0) {
        tr.append($("<th>").attr("colspan", rowAttrs.length).attr("rowspan", colAttrs.length));
      }
      tr.append($("<th class='pvtAxisLabel'>").text(c));
      for (i in colKeys) {
        if (!__hasProp.call(colKeys, i)) continue;
        colKey = colKeys[i];
        x = spanSize(colKeys, parseInt(i), parseInt(j));
        if (x !== -1) {
          th = $("<th class='pvtColLabel'>").text(colKey[j]).attr("colspan", x);
          if (parseInt(j) === colAttrs.length - 1 && rowAttrs.length !== 0) {
            th.attr("rowspan", 2);
          }
          tr.append(th);
        }
      }
      if (parseInt(j) === 0) {
        tr.append($("<th class='pvtTotalLabel'>").text(opts.localeStrings.totals).attr("rowspan", colAttrs.length + (rowAttrs.length === 0 ? 0 : 1)));
      }
      result.append(tr);
    }
    if (rowAttrs.length !== 0) {
      tr = $("<tr>");
      for (i in rowAttrs) {
        if (!__hasProp.call(rowAttrs, i)) continue;
        r = rowAttrs[i];
        tr.append($("<th class='pvtAxisLabel'>").text(r));
      }
      th = $("<th>");
      if (colAttrs.length === 0) {
        th.addClass("pvtTotalLabel").text(opts.localeStrings.totals);
      }
      tr.append(th);
      result.append(tr);
    }
    for (i in rowKeys) {
      if (!__hasProp.call(rowKeys, i)) continue;
      rowKey = rowKeys[i];
      tr = $("<tr>");
      for (j in rowKey) {
        if (!__hasProp.call(rowKey, j)) continue;
        txt = rowKey[j];
        x = spanSize(rowKeys, parseInt(i), parseInt(j));
        if (x !== -1) {
          th = $("<th class='pvtRowLabel'>").text(txt).attr("rowspan", x);
          if (parseInt(j) === rowAttrs.length - 1 && colAttrs.length !== 0) {
            th.attr("colspan", 2);
          }
          tr.append(th);
        }
      }
      for (j in colKeys) {
        if (!__hasProp.call(colKeys, j)) continue;
        colKey = colKeys[j];
        aggregator = pivotData.getAggregator(rowKey, colKey);
        val = aggregator.value();
        tr.append($("<td class='pvtVal row" + i + " col" + j + "'>").html(aggregator.format(val)).data("value", val));
      }
      totalAggregator = pivotData.getAggregator(rowKey, []);
      val = totalAggregator.value();
      tr.append($("<td class='pvtTotal rowTotal'>").html(totalAggregator.format(val)).data("value", val).data("for", "row" + i));
      result.append(tr);
    }
    tr = $("<tr>");
    th = $("<th class='pvtTotalLabel'>").text(opts.localeStrings.totals);
    th.attr("colspan", rowAttrs.length + (colAttrs.length === 0 ? 0 : 1));
    tr.append(th);
    for (j in colKeys) {
      if (!__hasProp.call(colKeys, j)) continue;
      colKey = colKeys[j];
      totalAggregator = pivotData.getAggregator([], colKey);
      val = totalAggregator.value();
      tr.append($("<td class='pvtTotal colTotal'>").html(totalAggregator.format(val)).data("value", val).data("for", "col" + j));
    }
    totalAggregator = pivotData.getAggregator([], []);
    val = totalAggregator.value();
    tr.append($("<td class='pvtGrandTotal'>").html(totalAggregator.format(val)).data("value", val));
    result.append(tr);
    result.data("dimensions", [rowKeys.length, colKeys.length]);
    return result;
  };

  /*
  Pivot Table
  */


  $.fn.pivot = function(input, opts) {
    var defaults, e, pivotData, result;
    defaults = {
      cols: [],
      rows: [],
      filter: function() {
        return true;
      },
      aggregator: aggregators.count(),
      derivedAttributes: {},
      renderer: pivotTableRenderer,
      rendererOptions: null,
      localeStrings: {
        renderError: "An error occurred rendering the PivotTable results.",
        computeError: "An error occurred computing the PivotTable results."
      }
    };
    opts = $.extend(defaults, opts);
    result = null;
    try {
      pivotData = getPivotData(input, opts.cols, opts.rows, opts.aggregator, opts.filter, opts.derivedAttributes);
      try {
        result = opts.renderer(pivotData, opts.rendererOptions);
      } catch (_error) {
        e = _error;
        if (typeof console !== "undefined" && console !== null) {
          console.error(e.stack);
        }
        result = opts.localeStrings.renderError;
      }
    } catch (_error) {
      e = _error;
      if (typeof console !== "undefined" && console !== null) {
        console.error(e.stack);
      }
      result = opts.localeStrings.computeError;
    }
    this.html(result);
    return this;
  };

  /*
  UI code, calls pivot table above
  */


  $.fn.pivotUI = function(input, inputOpts, overwrite) {
    var aggregator, axisValues, c, colList, defaults, e, existingOpts, i, k, opts, pivotTable, refresh, refreshDelayed, renderer, rendererControl, shownAttributes, tblCols, tr1, tr2, uiTable, x, _fn, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1, _ref2, _ref3, _ref4, _ref5,
      _this = this;
    if (overwrite == null) {
      overwrite = false;
    }
    defaults = {
      derivedAttributes: {},
      aggregators: aggregators,
      renderers: renderers,
      hiddenAttributes: [],
      menuLimit: 200,
      cols: [],
      rows: [],
      vals: [],
      exclusions: {},
      unusedAttrsVertical: false,
      autoSortUnusedAttrs: false,
      rendererOptions: null,
      onRefresh: null,
      filter: function() {
        return true;
      },
      localeStrings: {
        renderError: "An error occurred rendering the PivotTable results.",
        computeError: "An error occurred computing the PivotTable results.",
        uiRenderError: "An error occurred rendering the PivotTable UI.",
        selectAll: "Select All",
        selectNone: "Select None",
        tooMany: "(too many to list)"
      }
    };
    existingOpts = this.data("pivotUIOptions");
    if ((existingOpts == null) || overwrite) {
      opts = $.extend(defaults, inputOpts);
    } else {
      opts = existingOpts;
    }
    try {
      input = convertToArray(input);
      tblCols = (function() {
        var _ref, _results;
        _ref = input[0];
        _results = [];
        for (k in _ref) {
          if (!__hasProp.call(_ref, k)) continue;
          _results.push(k);
        }
        return _results;
      })();
      _ref = opts.derivedAttributes;
      for (c in _ref) {
        if (!__hasProp.call(_ref, c)) continue;
        if ((__indexOf.call(tblCols, c) < 0)) {
          tblCols.push(c);
        }
      }
      axisValues = {};
      for (_i = 0, _len = tblCols.length; _i < _len; _i++) {
        x = tblCols[_i];
        axisValues[x] = {};
      }
      forEachRecord(input, opts.derivedAttributes, function(record) {
        var v, _base, _results;
        _results = [];
        for (k in record) {
          if (!__hasProp.call(record, k)) continue;
          v = record[k];
          if (v == null) {
            v = "null";
          }
          if ((_base = axisValues[k])[v] == null) {
            _base[v] = 0;
          }
          _results.push(axisValues[k][v]++);
        }
        return _results;
      });
      uiTable = $("<table class='table table-bordered' cellpadding='5'>");
      rendererControl = $("<td>");
      renderer = $("<select class='pvtRenderer'>").bind("change", function() {
        return refresh();
      });
      _ref1 = opts.renderers;
      for (x in _ref1) {
        if (!__hasProp.call(_ref1, x)) continue;
        renderer.append($("<option>").val(x).text(x));
      }
      rendererControl.append(renderer);
      colList = $("<td class='pvtAxisContainer pvtUnused'>");
      if (opts.unusedAttrsVertical) {
        colList.addClass('pvtVertList');
      } else {
        colList.addClass('pvtHorizList');
      }
      shownAttributes = (function() {
        var _j, _len1, _results;
        _results = [];
        for (_j = 0, _len1 = tblCols.length; _j < _len1; _j++) {
          c = tblCols[_j];
          if (__indexOf.call(opts.hiddenAttributes, c) < 0) {
            _results.push(c);
          }
        }
        return _results;
      })();
      _fn = function(c) {
        var attrElem, btns, checkContainer, filterItem, filterItemExcluded, hasExcludedItem, keys, showFilterList, triangleLink, updateFilter, v, valueList, _j, _len1, _ref2;
        keys = (function() {
          var _results;
          _results = [];
          for (k in axisValues[c]) {
            _results.push(k);
          }
          return _results;
        })();
        hasExcludedItem = false;
        valueList = $("<div>").addClass('pvtFilterBox').css({
          "z-index": 100,
          "width": "280px",
          "border": "1px solid gray",
          "background": "white",
          "display": "none",
          "position": "absolute",
          "padding": "20px"
        });
        valueList.append($("<div>").css({
          "text-align": "center",
          "font-weight": "bold"
        }).text("" + c + " (" + keys.length + ")"));
        if (keys.length > opts.menuLimit) {
          valueList.append($("<p>").css({
            "text-align": "center"
          }).text(opts.localeStrings.tooMany));
        } else {
          btns = $("<p>").css({
            "text-align": "center",
            "margin-bottom": "5px"
          });
          btns.append($("<button>").text(opts.localeStrings.selectAll).bind("click", function() {
            return valueList.find("input").prop("checked", true);
          }));
          btns.append($("<button>").text(opts.localeStrings.selectNone).bind("click", function() {
            return valueList.find("input").prop("checked", false);
          }));
          valueList.append(btns);
          checkContainer = $("<div>").css({
            "overflow": "scroll",
            "width": "280px",
            "max-height": "200px"
          });
          _ref2 = keys.sort(naturalSort);
          for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
            k = _ref2[_j];
            v = axisValues[c][k];
            filterItem = $("<label>");
            filterItemExcluded = opts.exclusions[c] ? (__indexOf.call(opts.exclusions[c], k) >= 0) : false;
            hasExcludedItem || (hasExcludedItem = filterItemExcluded);
            filterItem.append($("<input type='checkbox' class='pvtFilter'>").attr("checked", !filterItemExcluded).data("filter", [c, k]));
            filterItem.append($("<span>").text("" + k + " (" + v + ")"));
            checkContainer.append($("<p>").css("margin", "5px").append(filterItem));
          }
          valueList.append(checkContainer);
        }
        updateFilter = function() {
          var unselectedCount;
          unselectedCount = $(valueList).find("[type='checkbox']").length - $(valueList).find("[type='checkbox']:checked").length;
          if (unselectedCount > 0) {
            attrElem.addClass("pvtFilteredAttribute");
          } else {
            attrElem.removeClass("pvtFilteredAttribute");
          }
          if (keys.length > opts.menuLimit) {
            return valueList.toggle();
          } else {
            return valueList.toggle(0, refresh);
          }
        };
        valueList.append($("<p>").css({
          "text-align": "center",
          "margin-bottom": 0
        }).append($("<button>").text("OK").bind("click", updateFilter)));
        showFilterList = function(e) {
          return valueList.css({
            left: e.pageX,
            top: e.pageY
          }).toggle();
        };
        triangleLink = $("<span class='pvtTriangle'>").html(" &#x25BE;").bind("click", showFilterList);
        attrElem = $("<li class='label label-info axis_" + i + "'>").append($("<nobr>").text(c).data("attrName", c).append(triangleLink));
        if (hasExcludedItem) {
          attrElem.addClass('pvtFilteredAttribute');
        }
        colList.append(attrElem).append(valueList);
        return attrElem.bind("dblclick", showFilterList);
      };
      for (i in shownAttributes) {
        c = shownAttributes[i];
        _fn(c);
      }
      tr1 = $("<tr>");
      aggregator = $("<select class='pvtAggregator'>").css("margin-bottom", "5px").bind("change", function() {
        return refresh();
      });
      _ref2 = opts.aggregators;
      for (x in _ref2) {
        if (!__hasProp.call(_ref2, x)) continue;
        aggregator.append($("<option>").val(x).text(x));
      }
      tr1.append($("<td class='pvtAxisContainer pvtHorizList pvtVals'>").css("text-align", "center").append(aggregator).append($("<br>")));
      tr1.append($("<td class='pvtAxisContainer pvtHorizList pvtCols'>"));
      uiTable.append(tr1);
      tr2 = $("<tr>");
      tr2.append($("<td valign='top' class='pvtAxisContainer pvtRows'>"));
      pivotTable = $("<td valign='top' class='pvtRendererArea'>");
      tr2.append(pivotTable);
      uiTable.append(tr2);
      if (opts.unusedAttrsVertical) {
        uiTable.find('tr:nth-child(1)').prepend(rendererControl);
        uiTable.find('tr:nth-child(2)').prepend(colList.css('vertical-align', 'top'));
      } else {
        uiTable.prepend($("<tr>").append(rendererControl).append(colList));
      }
      this.html(uiTable);
      _ref3 = opts.cols;
      for (_j = 0, _len1 = _ref3.length; _j < _len1; _j++) {
        x = _ref3[_j];
        this.find(".pvtCols").append(this.find(".axis_" + (shownAttributes.indexOf(x))));
      }
      _ref4 = opts.rows;
      for (_k = 0, _len2 = _ref4.length; _k < _len2; _k++) {
        x = _ref4[_k];
        this.find(".pvtRows").append(this.find(".axis_" + (shownAttributes.indexOf(x))));
      }
      _ref5 = opts.vals;
      for (_l = 0, _len3 = _ref5.length; _l < _len3; _l++) {
        x = _ref5[_l];
        this.find(".pvtVals").append(this.find(".axis_" + (shownAttributes.indexOf(x))));
      }
      if (opts.aggregatorName != null) {
        this.find(".pvtAggregator").val(opts.aggregatorName);
      }
      if (opts.rendererName != null) {
        this.find(".pvtRenderer").val(opts.rendererName);
      }
      refreshDelayed = function() {
        var exclusions, natSort, subopts, unusedAttrsContainer, vals;
        subopts = {
          derivedAttributes: opts.derivedAttributes,
          localeStrings: opts.localeStrings,
          rendererOptions: opts.rendererOptions,
          cols: [],
          rows: []
        };
        vals = [];
        _this.find(".pvtRows li nobr").each(function() {
          return subopts.rows.push($(this).data("attrName"));
        });
        _this.find(".pvtCols li nobr").each(function() {
          return subopts.cols.push($(this).data("attrName"));
        });
        _this.find(".pvtVals li nobr").each(function() {
          return vals.push($(this).data("attrName"));
        });
        subopts.aggregator = opts.aggregators[aggregator.val()](vals);
        subopts.renderer = opts.renderers[renderer.val()];
        exclusions = {};
        _this.find('input.pvtFilter').not(':checked').each(function() {
          var filter;
          filter = $(this).data("filter");
          console.log(filter);
          if (exclusions[filter[0]] != null) {
            return exclusions[filter[0]].push(filter[1]);
          } else {
            return exclusions[filter[0]] = [filter[1]];
          }
        });
        subopts.filter = function(record) {
          var excludedItems, _ref6;
          if (!opts.filter(record)) {
            return false;
          }
          for (k in exclusions) {
            excludedItems = exclusions[k];
            if (_ref6 = "" + record[k], __indexOf.call(excludedItems, _ref6) >= 0) {
              return false;
            }
          }
          return true;
        };
        pivotTable.pivot(input, subopts);
        _this.data("pivotUIOptions", {
          cols: subopts.cols,
          rows: subopts.rows,
          vals: vals,
          exclusions: exclusions,
          hiddenAttributes: opts.hiddenAttributes,
          renderers: opts.renderers,
          aggregators: opts.aggregators,
          filter: opts.filter,
          derivedAttributes: opts.derivedAttributes,
          aggregatorName: aggregator.val(),
          rendererName: renderer.val(),
          localeStrings: opts.localeStrings,
          rendererOptions: opts.rendererOptions
        });
        if (opts.autoSortUnusedAttrs) {
          natSort = $.pivotUtilities.naturalSort;
          unusedAttrsContainer = _this.find("td.pvtUnused.pvtAxisContainer");
          $(unusedAttrsContainer).children("li").sort(function(a, b) {
            return natSort($(a).text(), $(b).text());
          }).appendTo(unusedAttrsContainer);
        }
        pivotTable.css("opacity", 1);
        if (opts.onRefresh != null) {
          return opts.onRefresh();
        }
      };
      refresh = function() {
        pivotTable.css("opacity", 0.5);
        return setTimeout(refreshDelayed, 10);
      };
      refresh();
      this.find(".pvtAxisContainer").sortable({
        update: refresh,
        connectWith: this.find(".pvtAxisContainer"),
        items: 'li',
        placeholder: 'placeholder'
      });
    } catch (_error) {
      e = _error;
      if (typeof console !== "undefined" && console !== null) {
        console.error(e.stack);
      }
      this.html(opts.localeStrings.uiRenderError);
    }
    return this;
  };

  /*
  Heatmap post-processing
  */


  $.fn.heatmap = function(scope) {
    var colorGen, heatmapper, i, j, numCols, numRows, _i, _j, _ref,
      _this = this;
    if (scope == null) {
      scope = "heatmap";
    }
    _ref = this.data("dimensions"), numRows = _ref[0], numCols = _ref[1];
    colorGen = function(color, min, max) {
      var hexGen;
      hexGen = (function() {
        switch (color) {
          case "red":
            return function(hex) {
              return "ff" + hex + hex;
            };
          case "green":
            return function(hex) {
              return "" + hex + "ff" + hex;
            };
          case "blue":
            return function(hex) {
              return "" + hex + hex + "ff";
            };
        }
      })();
      return function(x) {
        var hex, intensity;
        intensity = 255 - Math.round(255 * (x - min) / (max - min));
        hex = intensity.toString(16).split(".")[0];
        if (hex.length === 1) {
          hex = 0 + hex;
        }
        return hexGen(hex);
      };
    };
    heatmapper = function(scope, color) {
      var colorFor, forEachCell, values;
      forEachCell = function(f) {
        return _this.find(scope).each(function() {
          var x;
          x = $(this).data("value");
          if ((x != null) && isFinite(x)) {
            return f(x, $(this));
          }
        });
      };
      values = [];
      forEachCell(function(x) {
        return values.push(x);
      });
      colorFor = colorGen(color, Math.min.apply(Math, values), Math.max.apply(Math, values));
      return forEachCell(function(x, elem) {
        return elem.css("background-color", "#" + colorFor(x));
      });
    };
    switch (scope) {
      case "heatmap":
        heatmapper(".pvtVal", "red");
        break;
      case "rowheatmap":
        for (i = _i = 0; 0 <= numRows ? _i < numRows : _i > numRows; i = 0 <= numRows ? ++_i : --_i) {
          heatmapper(".pvtVal.row" + i, "red");
        }
        break;
      case "colheatmap":
        for (j = _j = 0; 0 <= numCols ? _j < numCols : _j > numCols; j = 0 <= numCols ? ++_j : --_j) {
          heatmapper(".pvtVal.col" + j, "red");
        }
    }
    heatmapper(".pvtTotal.rowTotal", "red");
    heatmapper(".pvtTotal.colTotal", "red");
    return this;
  };

  /*
  Barchart post-processing
  */


  $.fn.barchart = function() {
    var barcharter, i, numCols, numRows, _i, _ref,
      _this = this;
    _ref = this.data("dimensions"), numRows = _ref[0], numCols = _ref[1];
    barcharter = function(scope) {
      var forEachCell, max, scaler, values;
      forEachCell = function(f) {
        return _this.find(scope).each(function() {
          var x;
          x = $(this).data("value");
          if ((x != null) && isFinite(x)) {
            return f(x, $(this));
          }
        });
      };
      values = [];
      forEachCell(function(x) {
        return values.push(x);
      });
      max = Math.max.apply(Math, values);
      scaler = function(x) {
        return 100 * x / (1.4 * max);
      };
      return forEachCell(function(x, elem) {
        var text, wrapper;
        text = elem.text();
        wrapper = $("<div>").css({
          "position": "relative",
          "height": "55px"
        });
        wrapper.append($("<div>").css({
          "position": "absolute",
          "bottom": 0,
          "left": 0,
          "right": 0,
          "height": scaler(x) + "%",
          "background-color": "gray"
        }));
        wrapper.append($("<div>").text(text).css({
          "position": "relative",
          "padding-left": "5px",
          "padding-right": "5px"
        }));
        return elem.css({
          "padding": 0,
          "padding-top": "5px",
          "text-align": "center"
        }).html(wrapper);
      });
    };
    for (i = _i = 0; 0 <= numRows ? _i < numRows : _i > numRows; i = 0 <= numRows ? ++_i : --_i) {
      barcharter(".pvtVal.row" + i);
    }
    barcharter(".pvtTotal.colTotal");
    return this;
  };

}).call(this);


            Rally.launchApp('CustomApp', {
                name:"cycletimebystate",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
    <style type="text/css">
        
table.pvtTable {
    font-family:arial;
    font-size: 8pt;
    text-align: left;
    border-collapse: collapse;
}
table.pvtTable tr th, table.pvtTable tr th {
    background-color: #e6EEEE;
    border: 1px solid #CDCDCD;
    font-size: 8pt;
    padding: 5px;
}

table.pvtTable .pvtColLabel {text-align: center;}
table.pvtTable .pvtTotalLabel {text-align: right;}

table.pvtTable tr td {
    color: #3D3D3D;
    padding: 5px;
    background-color: #FFF;
    border: 1px solid #CDCDCD;
    vertical-align: top;
    text-align: right;
}

.pvtTotal, .pvtGrandTotal { font-weight: bold; }

.pvtAxisContainer {
    border: 1px solid gray;
    background: #EEE;
    padding: 5px;
    min-width: 20px;
    min-height: 20px;
}
.pvtAxisContainer li {
    padding: 8px 6px;
    list-style-type: none;
    cursor:move;
}
.pvtAxisContainer li.placeholder {
    -webkit-border-radius: 5px;
    padding: 3px 15px;
    -moz-border-radius: 5px;
    border-radius: 5px;
    border: 1px dashed #aaa;
}

.pvtAxisContainer li nobr {
    background: #F3F3F3;
    border: 1px solid #DEDEDE;
    padding: 2px 5px;
    
    -webkit-border-radius: 5px;
    -moz-border-radius: 5px;
    border-radius: 5px;
}

.pvtTriangle {
    cursor:pointer;
    color: grey;
}

.pvtHorizList li { display: inline; }

.pvtFilteredAttribute { font-style: italic }

    </style>
</head>
<body></body>
</html>
